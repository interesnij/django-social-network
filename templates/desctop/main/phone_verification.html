{% load static %}
<!doctype html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Подтверждение профиля</title>
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon" />
    <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon" />
    <link rel="stylesheet" href="{% static 'styles/bootstrap.min.css' %}" media="all" />
    <link rel="stylesheet" href="{% static 'styles/default.css' %}" />
    <link rel="stylesheet" href="{% static 'styles/load.css' %}" media="none" onload="if(media!='all')media='all'" />
    <link media="none" onload="if(media!='all')media='all'" rel="stylesheet" href="{% static 'styles/color/white.css' %}" />
</head>

<body class="fixed-header main-container">
    <div class="wrapper">
      <header class="main-header">
          <div class="container">
              <div class="align-items-center" style="display:flex;flex-wrap:wrap;">
                <div class="col-auto" style="padding-left: 0;">
                    <a href="/" class="logo ajax">
                      <img src="/static/images/hakew.png" alt="logo">
                      <span style="margin-top:10px;float:left;"class="d-none d-sm-block">ТРЕЗВЫЙ.РУС</span>
                    </a>
                </div>

                      <div class="dropdown text-hide-xs d-inline-block" style="margin-left: auto;">
                          <a class="btn header-color-secondary username drop">
                             <figure class="userpic" data-device="comp" data-pk="{{ request.user.pk }}" data-name="{{ request.user.get_full_name }}">
                               {% if request.user.s_avatar %}
                                 <img src="{{ request.user.s_avatar.url }}" alt="">
                               {% else %}
                                 <svg fill="currentColor" class="svg_default svg_info" style="margin-bottom:40px;" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 5.9c1.16 0 2.1.94 2.1 2.1s-.94 2.1-2.1 2.1S9.9 9.16 9.9 8s.94-2.1 2.1-2.1m0 9c2.97 0 6.1 1.46 6.1 2.1v1.1H5.9V17c0-.64 3.13-2.1 6.1-2.1M12 4C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 9c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"/></svg>
                               {% endif %}
                             </figure>
                             <h5 class="text-hide-xs"><span class="header-color-primary">Мой профиль</span></h5>
                          </a>
                          <div class="dropdown-menu dropdown-menu-right profile-dropdown">
                              <div class="dropdown-divider m-0"></div>
                              <a class="dropdown-item" href="{% url 'logout' %}">
                                  <div class="row align-items-center">
                                      <div class="col">Выход</div>
                                      <div class="col-auto">
                                          <div class="text-danger ml-2">
                                            <svg fill="currentColor" class="svg_default svg_info" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 7 1.4z"/></svg>
                                          </div>
                                      </div>
                                  </div>
                              </a>
                              <div class="dropdown-divider m-0"></div>
                              <a class="dropdown-item ajax" href="{% url 'quan_categories' cat_name='popular_question' %}">
                                  <div class="row align-items-center">
                                      <div class="col">Помощь</div>
                                      <div class="col-auto">
                                          <div class="text-danger ml-2">
                                            <svg fill="currentColor" class="svg_default svg_info" viewBox="0 0 24 24">
                                              <path d="M0 0h24v24H0z" fill="none" />
                                              <path fill="currentColor" d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/>
                                            </svg>
                                          </div>
                                      </div>
                                  </div>
                              </a>
                              <div class="dropdown-divider m-0"></div>
                              <a class="dropdown-item ajax" href="{% url 'about' %}">
                                  <div class="row align-items-center">
                                      <div class="col">О сайте</div>
                                      <div class="col-auto">
                                          <div class="text-danger ml-2">
                                            <svg fill="currentColor" class="svg_default svg_info" viewBox="0 0 24 24">
                                              <path d="M0 0h24v24H0z" fill="none"/><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"/>
                                            </svg>
                                          </div>
                                      </div>
                                  </div>
                              </a>
                          </div>
                      </div>
                  </div>
              </div>
          </header>

        <span class="main-container col-xs-12 col-md-12 text-hide-xs jambotron-fluid" style="display:flex !important;flex-wrap: wrap;padding-right:0px;padding-left:0px;">
            <div class="col-md-1"></div>
            <div class="col-md-2"></div>
            <div class="col-md-7" id="ajax" style="padding-right:0px;padding-left:0px;">
                <h1 class="font-weight-light mb-3 mt-4 text-center">{{ request.user.get_full_name }}!</h1>
                <p  class="text-center">Для усиление информационной безопасности Вам нужно подтвердить с помощью телефона свой профиль, и в будущем использовать номер телефона в качестве логина к профилю соцсети трезвый.рус</p>
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-4" style="display: inline-flex;margin-top: 12px;margin-bottom: 12px;">
                        <input type="number" id="phone" min="0" onkeyup="phone_check();" class="form-control border-0" placeholder="Телефон">
                        <hr class="my-0">
                    </div>
                    <div class="col-md-4" style="margin-top: 12px;">
                        <button type="button" disabled="disabled" id="phone_send" class="btn btn-primary pink-gradient">Получить код</button>
                    </div>
                    <div class="col-md-2"></div>
                </div>
                <div id='jsondata' style="margin-top:50px"></div>

                <div id='jsondata2' style="margin-top:50px"></div>

              </div>
              <div class="col-md-2"></div>
        </span>
  </div>

    <script type="text/javascript">
    function on(elSelector, eventName, selector, fn) {
        var element = document.querySelector(elSelector);
        element.addEventListener(eventName, function(event) {
            var possibleTargets = element.querySelectorAll(selector);
            var target = event.target;
            for (var i = 0, l = possibleTargets.length; i < l; i++) {
                var el = target;
                var p = possibleTargets[i];
                while (el && el !== element) {
                    if (el === p) {
                        return fn.call(p, event);
                    }
                    el = el.parentNode;
                }
            }
        });
    };

            function phone_check() {
                if (document.getElementById('phone').value.length > 9)
                    document.getElementById("phone_send").removeAttribute('disabled');
                else
                    document.getElementById("phone_send").setAttribute("disabled", "true");
            }

            function code_check() {
                if (document.getElementById('code').value.length === 4)
                    document.getElementById("code_send").removeAttribute('disabled');
                else
                    document.getElementById("code_send").setAttribute("disabled", "true");
            }

            document.getElementById("phone_send").addEventListener("click", (e) => {
                _user_phone = document.getElementById('phone').value;
                _user_phone = _user_phone.replace(/[^0-9]/g, '');

                if (_user_phone[:2] == "+7") {
                  _user_phone = _user_phone.slice(2)
                }
            		else if (_user_phone[0] == "8") {
            			_user_phone = _user_phone.slice(1)
            		};
                _user_phone = 7 + _user_phone;

                var request = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');
                request.open('GET', "/users/progs/phone_send/" + _user_phone + "/", true);
                request.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        var div = document.getElementById('jsondata');
                        div.innerHTML = request.responseText;
                    }
                };
                request.send(null);
            });
            on('#ajax', 'click', '#code_send', function() {
              _user_phone = document.getElementById('phone').value;
              _user_phone = _user_phone.replace(/[^0-9]/g, '');

              if (_user_phone[0] == "+7") {
                _user_phone = _user_phone.slice(2)
              }
              else if (_user_phone[0] == "8") {
                _user_phone = _user_phone.slice(1)
              };
              _user_phone = 7 + _user_phone;

                var code = document.getElementById('code').value;
                var request = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');
                request.open('GET', "/users/progs/phone_verify/" + _user_phone + "/" + code + "/", true);
                request.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        var div = document.getElementById('jsondata2');
                        div.innerHTML = request.responseText;
                        console.log(request.responseText);
                        if (request.responseText.indexOf("ok") != -1) {
                            window.location.href = "{% url 'user' pk=request.user.pk %}";
                        }
                    }
                };
                request.send(null)
            });
        </script>
</body>
</html>
